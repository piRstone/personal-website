---
title: Rendre ses volets roulants Eveno compatibles avec Apple HomeKit
excerpt: Comment associer ses volets roulants Eveno / Profalux pilot√©s en Zigbee √† l'app Maison pour pouvoir les commander depuis son t√©l√©phone ou gr√¢ce √† Siri.
publishedAt: "2021-05-10"
picture: https://source.unsplash.com/JNIVMXNoaYs/1920x900
category: domotique
---

## Zigbee c'est bien, mais gare √† la compatibilit√© !

J'ai r√©cemment fais construire ma maison et au moment de la conception, mon constructeur me proposait de choisir entre deux mod√®les : un de la marque Somfy avec son protocole propri√©taire et ses accessoires au co√ªt non n√©gligeable, et un autre de marque Eveno (que je ne connaissais alors pas) utilisant le protocole **[Zibgee](https://zigbeealliance.org/fr/)**, donc open-source (et aussi moins cher üòÑ) !

√Ä ce moment l√†, la balance penche vers les volets Eveno avec dans ma t√™te la promesse de pouvoir les g√©rer moi-m√™me √† l'aide d'un **Raspberry Pi** et du **[pont Hombridge](https://homebridge.io/)**, projet open-source que j'avais d√©couvert un peu avant.

Je me suis renseign√© entre temps pour savoir comment m'y prendre et surtout, quel hardware utiliser pour √©mettre ce fameux signal Zigbee. Apr√®s plusieurs heures de recherches et de comparaison entre les diff√©rentes solutions existantes, mon choix s'arr√™te sur la cl√© USB **[Phoscon Conbee II](https://phoscon.de/en/conbee2)**.

![La cl√© USB Conbee II](https://phoscon.de/conbee/img/01_PANA6449_2.jpg)

Des mois plus tard et l'emm√©nagement fait, je m‚Äôattelle √† la mise en place de cette infrastructure. Sauf que je me rends compte √† ce moment l√† (un peu tard oui) que ces volets ne sont pas dans la [liste officielle des appareils compatibles](https://phoscon.de/en/conbee2/compatible) avec la Conbee II et son plugin **deconZ**. Par chance, [une demande d'int√©gration](https://github.com/dresden-elektronik/deconz-rest-plugin/issues/2739) de ceux-ci a √©t√© faite en mai 2020 sur Github. Eh oui parce que l'avantage de cette cl√© USB Zigbee est que [son plugin est open-source](https://github.com/dresden-elektronik/deconz-rest-plugin) ! On a donc facilement acc√®s √† une API REST pour g√©rer tous les appareils qui y ont √©t√© associ√©s.

Attaquons donc cette installation !

## Installation d'Homebridge

Il nous faut tout d'abord un **Raspberry Pi** avec une installation standard de [Raspberry Pi OS Lite](https://www.raspberrypi.org/software/operating-systems/) (la version headless). J'utilise chez moi un Raspberry Pi 3.

Comme il est headless, on va se faciliter la tache en activant de base le SSH et en configurant notre WiFi pour qu'il s'y connecte tout seul au d√©marrage. Pour ce, cr√©ez un fichier nomm√© `ssh` (sans extension) √† la racine de la carte SD.

Pour le WiFi, cr√©ez √† la racine √©galement un fichier `wpa_supplicant.conf` dans lequel on va ajouter les identifiants du routeur

```bash
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
country=GB

network={
	ssid="Livebox-XXXX"               # SSID de votre box
	psk="0A0139E1FF483D72F948F0F045"  # Mot de passe WiFi
	key_mgmt=WPA-PSK
}
```

Maintenant que notre OS est install√© et bien connect√© √† internet, on peut [installer Homebridge](https://github.com/homebridge/homebridge/wiki/Install-Homebridge-on-Raspbian). On aura besoin de l'adresse IP du Raspberry pour pourvoir acc√©der √† l'interface web.

On commence par installer Node JS :

```bash
# setup repo
curl -sL https://deb.nodesource.com/setup_14.x | sudo bash -

# install Node.js
sudo apt install -y nodejs gcc g++ make python net-tools

# test node is working
node -v
```

On installe ensuite Homebridge et son interface web :

```bash
sudo npm install -g --unsafe-perm homebridge homebridge-config-ui-x
```

Enfin on termine par activer le service qui fera en sorte qu'Homebridge se lance automatiquement au red√©marrage du Raspberry :

```bash
sudo hb-service install --user homebridge
```

On peut maintenant acc√©der √† l'interface web d'Homebridge en saisissant son IP suivi de son port dans un navigateur : **http://192.168.1.15:8581**

![L'interface web de Homebridge](https://user-images.githubusercontent.com/3979615/71886653-b16d3f80-3190-11ea-9ff8-49dc4ae4fff0.png)

Et voil√† !

Il ne reste plus qu'√† ouvrir l'appareil photo de votre iPhone et de scanner le QR Code en haut √† gauche pour que le pont soit ajout√© automatiquement dans l'app Maison !

## Installation de deconZ

Installons maintenant [le plugin deconZ]() via lequel nous allons piloter nos √©quipements.

On commence par donner les droits √† notre utilisateur d'acc√©der aux ports USB :

```bash
sudo gpasswd -a $USER dialout
```

*√Ä noter d'un red√©marrage sera n√©cessaire pour prendre en compte ce changement*

On ajoute la cl√© publique de Phoscon :

```bash
 wget -O - http://phoscon.de/apt/deconz.pub.key | \
           sudo apt-key add -
```

Puis on ajoute le d√©p√¥t deconZ (version stable) √† la liste des d√©p√¥ts APT :

```bash
sudo sh -c "echo 'deb http://phoscon.de/apt/deconz \
            $(lsb_release -cs) main' > \
            /etc/apt/sources.list.d/deconz.list"
```

Enfin, on met √† jour la liste des paquets et on installe deconZ :

```bash
sudo apt update
sudo apt install deconz
```

Une derni√®re manip √† faire est de [d√©sactiver l'app desktop](https://github.com/dresden-elektronik/deconz-rest-plugin#headless-support-for-linux) qui est install√©e de base et qui ne nous servira pas √©tant donn√© que nous sommes en headless ! On activera le service deconZ dans le m√™me temps pour qu'il se lance au d√©marrage du Raspberry :

```bash
sudo systemctl enable deconz
sudo systemctl disable deconz-gui
sudo systemctl stop deconz-gui
```

üîÑ On peut maintenant red√©marrer notre Raspberry.

Une fois relanc√©, vous devriez voir l'interface web de deconZ en acc√©dant √† l'IP du Raspberry (sans port) : http://192.168.1.15

![Interface de deconZ](/img/rendre-ses-volets-roulants-eveno-compatibles-avec-apple-homekit/deconz-interface.png)

Cr√©ez un groupe pour pouvoir y ajouter plus tard vos volets.

### Conbee II mal reconnue par deconZ

Si votre cl√© USB est mal reconnue, avec *Vendor unknown* et aucun *Product* name il faudra mettre √† jour le firmware de celle-ci.

![La cl√© Conbee II n'est pas reconnue par deconZ](/img/rendre-ses-volets-roulants-eveno-compatibles-avec-apple-homekit/conbee-ii-not-recognized.png)

Pour ce faire, je vous invite √† suivre cette proc√©dure : [https://github.com/dresden-elektronik/deconz-rest-plugin/wiki/Update-deCONZ-manually#update-in-ubuntu](https://github.com/dresden-elektronik/deconz-rest-plugin/wiki/Update-deCONZ-manually#update-in-ubuntu)

Une fois faite, vous devriez voir l'image de la Conbee II et les bonnes informations apparaitre.

## Appairage des volets

Maintenant que tout fonctionne, on peut appairer nos volets !

J'ai pour ma part des t√©l√©commandes murales Zigbee mais la proc√©dure est la m√™me pour les t√©l√©commandes portables.

![La t√©l√©commande sans fil Zigbee des volets roulants](/img/rendre-ses-volets-roulants-eveno-compatibles-avec-apple-homekit/remote-recto.jpg)

On commence donc par prendre un trombone üìé  et √† retourner l√† t√©l√©commande. Il y a au dos 2 trous : un R et un F.

![Le dos de la t√©l√©commande avec les boutons R et F](/img/rendre-ses-volets-roulants-eveno-compatibles-avec-apple-homekit/remote-verso.jpg)

![Proc√©dure de r√©initialiation de la t√©l√©commande](/img/rendre-ses-volets-roulants-eveno-compatibles-avec-apple-homekit/profalux-inclusion-etape1.png)

- Appuyez **5 fois sur R**. Assurez-vous de bien voir la LED rouge clignoter √† chaque appui.
- La t√©l√©commande clignote vert et volet fait un petit va-et-vient.
- Attendre que le volet ne bouge plus et que la t√©l√©commande ne clignote plus puis **dans la minute qui suit**, appuyez sur STOP.
- Le volet refait un petit va-et-vient.

√Ä ce moment le volet fonctionne √† l'envers si vous essayez de le bouger. Pour inverser la commande :

- Appuyez une fois sur F.
- Puis appuyez sur STOP.
- Le volet fait un petit va-et-vient.

La commande est d√©sormais dans le bon sens.

- Fermez le volet compl√®tement.

**Inclusion du volet**

Dans le groupe que vous avez cr√©√© auparavant, cliquez sur **Edit** puis sur **Manage lights** enfin sur **Add new light**. L√† une barre de chargement s'affiche, deconZ est entr√© en mode inclusion.

![La passerelle est ouverte pour l'inclusion de nouveaux appareils](/img/rendre-ses-volets-roulants-eveno-compatibles-avec-apple-homekit/deconz-gateway-opened.jpg)

Reprenez votre t√©l√©commande puis :

- Appuyez **une fois sur R.**
- Puis appuyez sur la fl√®che du haut.
- Le volet fait plusieurs petits va-et-vient. Attendez que la t√©l√©commande ne clignote plus et que le volet ne bouge plus.
- Appuyez sur la touche STOP.
- Ouvrez et fermez **2 FOIS compl√®tement** le volet.
- √Ä la 2√®me fermeture, le volet fait un petit va-et-vient.

Le volet doit apparaitre sous le nom de *New light 1*.

Si le volet apparait avant la fin des mouvements du volets, terminez quand m√™me la proc√©dure jusqu'au bout sous peine que le volet ne fonctionne pas correctement par la suite.

Vous pouvez maintenant cliquer sur *New light 1* pour le renommer. Pendant que la fen√™tre d'√©dition est ouverte, le volet fait des petits mouvements pour s'identifier et s'assurer qu'on modifie le bon.

Si vous avez perdu le lien entre la t√©l√©commande et le volet par une fausse manip, vous allez malheureusement devoir ouvrir votre volet pour acc√©der √† son √©metteur üòû [La proc√©dure est ici en bas de page](http://kiwihc16.free.fr/Profalux.html).

## Lier deconZ √† Homebridge

Nous pouvons d√©sormais lier deconZ √† Homebridge pour faire apparaitre nos volets dans l'app Maison !

Rendez-vous sur l'interface d'Homebridge et dans l'onglet **Plugins**, recherchez **[homebridge-hue](https://github.com/ebaauw/homebridge-hue)** et installez-le.

Il s'agit d'un plugin open-source qui permet de g√©rer les accessoires utilisant le protocole Zigbee. Cr√©√© √† la base pour Philips Hue, il peut √©galement piloter les accessoires associ√©s avec deconZ.

Une fois install√©, une fen√™tre de param√®tres s'ouvre.

Dans le champ **Bridges/Gateways**, saisissez **127.0.0.1** qui correspond √† l'adresse locale de notre Raspberry √©tant donn√© que deconZ est install√© sur le m√™me Raspi que Homebridge.

Maintenant, pour que homebridge-hue puisse acc√©der √† deconZ, il faut lui en donner l'autorisation. Pour ce faire, retournez dans l'interface de deconZ, dans **Settings > Gateway**, cliquez en bas sur **Advanced** puis sur **Authenticate app**.

Dans la minute qui suit, red√©marrez le service Homebridge en cliquant sur le bouton power en haut √† droite.

Vous devriez maintenant voir vos volet apparaitre dans l'onglet Accessoire et dans l'app Maison sur votre iPhone !

### Les volets apparaissent comme des ampoules

Un point important √† noter est que les volets apparaissent et se comportent comme des ampoules dans Maison.

![Les volets apparaissent comme des lumi√®res dans l'app Maison](/img/rendre-ses-volets-roulants-eveno-compatibles-avec-apple-homekit/shutter-appears-as-light.jpeg)

Je n'ai pour l'heure pas trouv√© de solution pour les faire appara√Ætre en tant que volets et visiblement [deconZ n'est pas l√† de faire en sorte que √ßa soit le cas malheureusement](https://github.com/ebaauw/homebridge-hue/issues/975).

Les commandes fonctionnent cependant correctement ainsi que les positions interm√©diaires. Vous pouvez donc demander √† Siri : "R√®gle volet salon √† 50%" ou encore "√âteint volet cuisine" pour agir sur ceux-ci par la voix.

Une autre solution est de cr√©er un raccourci dans l'app Raccourcis d'Apple pour cr√©er des sc√©nario fermant ou ouvrant tous les volets d'un coup.

Si une solution arrive par la suite pour r√©gler ce probl√®me, je ne manquerai pas de mettre √† jour cet article !

## R√©glage de la fin de course

La r√©initialisation de la t√©l√©commande lors de la proc√©dure d'appairage a perdu dans le m√™me temps le r√©glage de la fin de course du volet. Vous remarquerez qu'il remonte un peu plus haut qu'avant.

Pas de panique, il suffit de suivre les √©tapes qui suivent :

- Descendre et arr√™ter le volet √† mi-hauteur.
- Appuyer **5 fois sur F** (s‚Äôassurer que la LED clignote rouge √† chaque appui). Le volet fait un mouvement.
- Descendre **un peu** le volet puis appuyer sur STOP.
- Descendre **enti√®rement** le volet jusqu‚Äô√† ce qu‚Äôil s‚Äôarr√™te de lui-m√™me.
- Remonter le volet et **l‚Äôarr√™ter √† l‚Äôendroit voulu** en appuyant sur STOP.
- Descendre enti√®rement le volet jusqu‚Äô√† ce qu‚Äôil s‚Äôarr√™te de lui-m√™me.
- Remonter le volet enti√®rement. Il doit s‚Äôarr√™ter √† l‚Äôendroit r√©gl√© auparavant.
- Enfin, fermer le volet compl√®tement. Il fait un petit mouvement pour confirmer la fin de la proc√©dure.

Voil√†, vous pouvez d√©sormais profiter de votre installation sans avoir √† passer dans chaque pi√®ce chaque jour pour ouvrir et fermer chaque volet ! Le grand int√©r√™t de les associer dans l'app Maison est de profiter de la puissance des raccourcis pour automatiser plusieurs sc√©narios selon le moment de la journ√©e. J'ai entre autres cr√©√© un raccourci qui ouvre tous les volets de la maison quand j'√©teins mon r√©veil le matin, plus besoin d'y penser quand on se l√®ve !

√Ä vous d'adapter vos sc√©narios selon vos besoins !
